# PFN MCP Tool Definitions
# Source of truth for tool schemas - used by server.py and /tool-update skill
#
# tenant_aware: true = wrapper injects tenant from user context
# tenant_aware: false = global tool, no tenant injection

tools:
  # ===========================================================================
  # PHASE 1: Discovery Tools
  # ===========================================================================

  - name: list_tenants
    tenant_aware: false
    description: List all available tenants in the Valkyrie database
    params: []

  - name: list_devices
    tenant_aware: true
    description: >-
      Search for devices by name. Supports fuzzy matching.
      Returns device info with tenant context.
    params:
      - name: search
        type: string
        description: Search term to filter devices by name
      - name: tenant
        type: string
        description: "Tenant name or code to filter devices (e.g., 'PRS')"
      - name: limit
        type: integer
        description: "Maximum number of results per page (default: 20)"
        default: 20
      - name: offset
        type: integer
        description: "Number of results to skip for pagination (default: 0)"
        default: 0

  - name: list_quantities
    tenant_aware: false
    description: >-
      List available measurement quantities (metrics).
      Supports semantic search: 'voltage', 'power', 'energy', 'current',
      'power factor', 'thd', 'frequency', 'water', 'air'.
      Categories: Electricity, Water, Air, Gas.
    params:
      - name: category
        type: string
        description: "Filter by WAGE category. Accepts: electricity/electrical, water, air, gas"
      - name: search
        type: string
        description: >-
          Semantic search term: voltage, power, energy, current,
          power factor, thd, frequency, unbalance, water, air

  - name: list_device_quantities
    tenant_aware: false
    description: >-
      List quantities available for a specific device.
      Shows what measurements exist in telemetry for the device.
      Supports semantic search for quantity types.
    params:
      - name: device_id
        type: integer
        description: Device ID to query
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: search
        type: string
        description: "Filter by quantity type: voltage, power, energy, current, thd, etc."

  - name: compare_device_quantities
    tenant_aware: false
    description: >-
      Compare quantities available across multiple devices.
      Shows shared quantities and per-device breakdown.
      Useful for finding common measurements between devices.
    params:
      - name: device_ids
        type: array
        items: integer
        description: List of device IDs to compare
      - name: device_names
        type: array
        items: string
        description: List of device names (fuzzy search)
      - name: search
        type: string
        description: "Filter by quantity type: voltage, power, etc."

  - name: get_device_data_range
    tenant_aware: false
    description: >-
      Get the time range of available data for a device.
      Shows earliest/latest data timestamps, days of data, and quantity breakdown.
      Essential for knowing what date ranges to query.
    params:
      - name: device_id
        type: integer
        description: Device ID to query
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: quantity_id
        type: integer
        description: "Optional: check specific quantity"
      - name: quantity_search
        type: string
        description: "Optional: filter by quantity type (voltage, power, etc.)"

  - name: find_devices_by_quantity
    tenant_aware: true
    description: >-
      Find all devices that have data for a specific quantity.
      Useful for finding which devices track a particular metric.
      Groups results by tenant.
    params:
      - name: quantity_id
        type: integer
        description: Quantity ID to search for
      - name: quantity_search
        type: string
        description: Quantity search term (voltage, power, energy, etc.)
      - name: tenant
        type: string
        description: "Tenant name or code to filter results (e.g., 'PRS')"

  - name: get_device_info
    tenant_aware: false
    description: >-
      Get detailed device information including metadata.
      Shows manufacturer, model, Modbus address (slave_id + IP),
      location, and communication protocol.
      Can search by: device_id, device_name (fuzzy), or ip_address + slave_id.
      Use ip_address + slave_id for direct Modbus lookup (avoids brute-force search).
    params:
      - name: device_id
        type: integer
        description: Device ID to query
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: ip_address
        type: string
        description: IP address for Modbus search (requires slave_id)
      - name: slave_id
        type: integer
        description: Modbus slave ID for Modbus search (requires ip_address)
      - name: tenant
        type: string
        description: Tenant name or code filter (optional, narrows search)

  - name: check_data_freshness
    tenant_aware: true
    description: >-
      Check when data was last received for device(s).
      Identifies offline, stale, or recently active meters.
      Can check single device or all devices for a tenant.
    params:
      - name: device_id
        type: integer
        description: Device ID to check
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: tenant
        type: string
        description: "Tenant name or code to check all devices (e.g., 'PRS')"
      - name: hours_threshold
        type: integer
        description: "Hours to consider data 'stale' (default: 24)"
        default: 24

  - name: get_tenant_summary
    tenant_aware: true
    description: >-
      Get comprehensive tenant overview.
      Shows device counts, data range, quantity coverage by category,
      and device models. Good starting point for tenant analysis.
    params:
      - name: tenant_id
        type: integer
        description: Tenant ID to query
      - name: tenant_name
        type: string
        description: Tenant name (fuzzy search)

  # ===========================================================================
  # PHASE 2: Telemetry Tools
  # ===========================================================================

  - name: resolve_device
    tenant_aware: true
    description: >-
      Confirm device selection before querying telemetry.
      Returns ranked candidates with match confidence (exact/partial/fuzzy).
      Use BEFORE get_device_telemetry when user provides device name, not ID.
      Prevents wrong-device queries from ambiguous fuzzy matches.
    params:
      - name: search
        type: string
        description: Device name search term
        required: true
      - name: tenant
        type: string
        description: "Tenant name or code to filter devices (e.g., 'PRS')"
      - name: limit
        type: integer
        description: "Maximum candidates to return (default: 5)"
        default: 5

  - name: get_device_telemetry
    tenant_aware: true
    description: >-
      Fetch time-series telemetry data for a device.
      Returns aggregated data (avg, min, max, sum, count) with adaptive bucketing.
      Smart data source selection: uses raw 1-minute data for queries ≤4h (within 14 days),
      15-min aggregated for 4-24h, and pre-aggregated data for longer periods.

      **Default quantity mappings** (when user doesn't specify phase):
      - "current" → 100ms Current Avg (ID: 3324) - average across phases
      - "voltage" → 100ms Voltage L-N Avg (ID: 3332) - line-to-neutral average
      - "power factor" / "pf" → True Power Factor Total (ID: 1072)
      - "power" → Active Power (ID: 185)
      - "frequency" → Frequency (ID: 526)
      - "thd" → THD Voltage L-N (ID: 1119)
      For phase-specific data, use explicit names like "Current Phase A" or quantity IDs.

      **For energy/consumption queries, use get_energy_consumption instead** -
      this tool returns meter readings, not actual consumption values.
    params:
      - name: device_id
        type: integer
        description: Device ID (preferred over device_name)
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: quantity_id
        type: integer
        description: Quantity ID (preferred over quantity_search)
      - name: quantity_search
        type: string
        description: >-
          Quantity search term. Default mappings: "current"→3324, "voltage"→3332,
          "power factor"→1072, "power"→185, "frequency"→526, "thd"→1119.
          Use quantity IDs for phase-specific measurements.
      - name: period
        type: string
        description: "Time period: 1h, 24h, 7d, 30d, 3M, 1Y"
      - name: start_date
        type: string
        description: Start date (ISO format, alternative to period)
      - name: end_date
        type: string
        description: End date (ISO format, defaults to now)
      - name: bucket
        type: string
        description: "Bucket size: 1min (raw data), 15min, 1hour, 4hour, 1day, 1week, auto. Auto selects based on query duration and data availability."
        default: auto

  - name: get_quantity_stats
    tenant_aware: true
    description: >-
      Pre-flight validation before telemetry queries.
      Returns data availability stats: point count, min/max/avg values,
      first/last timestamps, data completeness percentage, and gaps.
      Use to verify data exists before calling get_device_telemetry.
    params:
      - name: device_id
        type: integer
        description: Device ID to query
        required: true
      - name: quantity_id
        type: integer
        description: Quantity ID (preferred over quantity_search)
      - name: quantity_search
        type: string
        description: "Quantity search: voltage, power, energy, etc."
      - name: period
        type: string
        description: "Time period to check (default: 30d)"
        default: 30d

  - name: get_energy_consumption
    tenant_aware: true
    description: >-
      Get energy consumption for a device.
      Returns actual consumption (not cumulative meter readings) calculated from
      interval deltas. Handles meter resets and data anomalies automatically.
      Smart data source: daily_energy_cost_summary for daily+, telemetry_intervals_cumulative for sub-daily.
      Default quantity: Active Energy. Use for energy queries instead of get_device_telemetry.
    params:
      - name: device_id
        type: integer
        description: Device ID (preferred over device_name)
      - name: device_name
        type: string
        description: Device name (fuzzy search)
      - name: quantity_id
        type: integer
        description: "Energy quantity ID (e.g., 124 for Active Energy Delivered)"
      - name: quantity_search
        type: string
        description: "Quantity search: energy, active energy, reactive energy, apparent energy"
      - name: period
        type: string
        description: "Time period: 1h, 24h, 7d, 30d, 3M, 1Y (default: 7d)"
      - name: start_date
        type: string
        description: Start date (ISO format, alternative to period)
      - name: end_date
        type: string
        description: End date (ISO format, defaults to now)
      - name: bucket
        type: string
        description: "Bucket size: 15min, 1hour, 4hour, 1day, 1week, auto"
        default: auto
      - name: include_quality_info
        type: boolean
        description: "Include data quality breakdown in response (default: false)"
        default: false

  # ===========================================================================
  # PHASE 2: Electricity Cost Tools
  # ===========================================================================

  - name: get_electricity_cost
    tenant_aware: true
    description: >-
      Get electricity consumption and cost for a device or tenant.
      Queries pre-aggregated daily cost data with time-of-use (TOU) rates.

      **Indonesian Electricity Rate Codes:**
      - WBP (Waktu Beban Puncak) = Peak Period (~Rp 1,550/kWh)
      - LWBP (Luar WBP) = Off-Peak Period (~Rp 1,035/kWh)
        - LWBP1: Morning off-peak
        - LWBP2: Night off-peak

      **Work Shifts:**
      - SHIFT1: Night (22:00-06:00)
      - SHIFT2: Day (06:00-14:00)
      - SHIFT3: Evening (14:00-22:00)

      **Group by options:**
      - none: Summary totals only (default)
      - daily: Per-day breakdown
      - shift: By work shift (SHIFT1/2/3)
      - rate: By electricity rate (WBP/LWBP)
      - source: By utility source (PLN/Solar)
      - shift_rate: Combined shift and rate matrix
      - daily_rate: Per-day breakdown by rate (compare rate distribution across days)
      - daily_shift: Per-day breakdown by shift

      Period formats: '7d', '1M', '2025-12', or 'YYYY-MM-DD to YYYY-MM-DD'.
    params:
      - name: device
        type: string
        description: Device name (fuzzy match)
      - name: tenant
        type: string
        description: Tenant name (fuzzy match)
      - name: period
        type: string
        description: "Time period: '7d', '30d', '1M', '2025-12', or 'YYYY-MM-DD to YYYY-MM-DD' (default: 7d)"
      - name: start_date
        type: string
        description: Explicit start date (YYYY-MM-DD)
      - name: end_date
        type: string
        description: Explicit end date (YYYY-MM-DD)
      - name: group_by
        type: string
        description: >-
          Grouping type: 'none' (summary only), 'daily', 'shift', 'rate', 'source',
          'shift_rate' (shift×rate matrix), 'daily_rate' (per-day by rate),
          'daily_shift' (per-day by shift). Default: none.
        enum: [none, daily, shift, rate, source, shift_rate, daily_rate, daily_shift]
        default: none

  - name: get_electricity_cost_ranking
    tenant_aware: true
    description: >-
      Rank devices by electricity cost or consumption within a tenant.
      Shows top consumers with percentage of total.
      Use for identifying high-cost equipment or usage patterns.
    params:
      - name: tenant
        type: string
        description: Tenant name (fuzzy match, required)
        required: true
      - name: period
        type: string
        description: "Time period: '7d', '30d', '1M' (default: 30d)"
      - name: start_date
        type: string
        description: Explicit start date (YYYY-MM-DD)
      - name: end_date
        type: string
        description: Explicit end date (YYYY-MM-DD)
      - name: metric
        type: string
        description: "Ranking metric: 'cost' or 'consumption' (default: cost)"
        enum: [cost, consumption]
        default: cost
      - name: limit
        type: integer
        description: "Number of results (default: 10)"
        default: 10

  - name: compare_electricity_periods
    tenant_aware: true
    description: >-
      Compare electricity costs between two time periods.
      Shows consumption and cost for each period with change metrics.
      Use for month-over-month or custom period comparisons.
    params:
      - name: device
        type: string
        description: Device name (fuzzy match)
      - name: tenant
        type: string
        description: Tenant name (fuzzy match)
      - name: period1
        type: string
        description: "First period (e.g., '2025-11', '30d')"
        required: true
      - name: period2
        type: string
        description: "Second period (e.g., '2025-12', '30d')"
        required: true

  # ===========================================================================
  # PHASE 2: Group Telemetry Tools
  # ===========================================================================

  - name: list_tags
    tenant_aware: true
    description: >-
      List available device tags for grouping.
      Tags allow flexible grouping by process, building, area, etc.
      Shows tag keys, values, and device counts by category.
    params:
      - name: tag_key
        type: string
        description: "Filter by specific tag key (e.g., 'process', 'building')"
      - name: tag_category
        type: string
        description: "Filter by tag category (e.g., 'location', 'production')"

  - name: list_tag_values
    tenant_aware: true
    description: >-
      List all values for a specific tag key with device counts.
      Shows which devices belong to each tag value.
      Use to explore available groupings before get_group_telemetry.
    params:
      - name: tag_key
        type: string
        description: "Tag key to list values for (e.g., 'process', 'building')"
        required: true

  - name: search_tags
    tenant_aware: false
    description: >-
      Search for device tags by value or key.
      Finds tags where tag_value or tag_key matches the search term.
      Use when you don't know which tag_key a value belongs to.
      Returns matching tag key/value pairs ranked by match quality.
      Example: search "PRS" to find tenant=PRS tag.
    params:
      - name: search
        type: string
        description: "Search term to match against tag_value and tag_key"
        required: true
      - name: limit
        type: integer
        description: "Maximum results to return (default: 10)"
        default: 10

  - name: get_group_telemetry
    tenant_aware: true
    description: >-
      Get aggregated telemetry for a group of devices.
      Default: electricity consumption/cost.
      With quantity: any WAGE metric (power, water flow, air pressure, etc.).
      Group by: single tag (tag_key + tag_value), multiple tags with AND logic (tags array),
      or asset hierarchy (asset_id).
      Supports breakdown by device or daily.
    params:
      - name: tag_key
        type: string
        description: "Tag key for single-tag grouping (e.g., 'process', 'building')"
      - name: tag_value
        type: string
        description: "Tag value to match (e.g., 'Waterjet', 'Factory A')"
      - name: tags
        type: array
        items: object
        description: >-
          Multi-tag AND query. List of {key, value} objects.
          Example: [{"key": "building", "value": "Factory B"}, {"key": "equipment_type", "value": "Compressor"}]
          Returns devices matching ALL specified tags.
      - name: asset_id
        type: integer
        description: Asset ID for hierarchy-based grouping
      - name: quantity_id
        type: integer
        description: Quantity ID for WAGE metrics (omit for electricity cost)
      - name: quantity_search
        type: string
        description: "Quantity search: power, voltage, water flow, air pressure, etc. (omit for electricity cost)"
      - name: period
        type: string
        description: "Time period: '7d', '1M', '2025-12' (default: 7d)"
      - name: start_date
        type: string
        description: Explicit start date (YYYY-MM-DD)
      - name: end_date
        type: string
        description: Explicit end date (YYYY-MM-DD)
      - name: breakdown
        type: string
        description: "Breakdown type: 'none', 'device', 'daily' (default: none). Only used with output=summary."
        enum: [none, device, daily]
        default: none
      - name: output
        type: string
        description: >-
          Output format: 'summary' (aggregated totals/averages),
          'timeseries' (time-aligned rows per device: [{time, device_1, device_2, ...}]).
          Default: summary. Timeseries requires quantity_id or quantity_search.
        enum: [summary, timeseries]
        default: summary

  - name: compare_groups
    tenant_aware: true
    description: >-
      Compare electricity consumption across multiple groups.
      Each group can be defined by tag or asset.
      Returns consumption, cost, and percentage for each group.
    params:
      - name: groups
        type: array
        items: object
        description: >-
          List of groups to compare. Each group needs either
          (tag_key + tag_value) or asset_id
        required: true
      - name: period
        type: string
        description: "Time period: '7d', '1M', '2025-12' (default: 7d)"
      - name: start_date
        type: string
        description: Explicit start date (YYYY-MM-DD)
      - name: end_date
        type: string
        description: Explicit end date (YYYY-MM-DD)

  # ===========================================================================
  # PHASE 2: Peak Analysis Tools
  # ===========================================================================

  - name: get_peak_analysis
    tenant_aware: true
    description: >-
      Find peak values with timestamps for a device or group.
      Returns top N peaks per bucket (hour/day/week).
      Shows which device caused each peak.
      Supports any WAGE quantity: power, flow, pressure, etc.
    params:
      - name: device_id
        type: integer
        description: Single device ID
      - name: device_name
        type: string
        description: Single device name (fuzzy search)
      - name: tag_key
        type: string
        description: "Tag key for group (e.g., 'process', 'building')"
      - name: tag_value
        type: string
        description: "Tag value for group (e.g., 'Waterjet')"
      - name: asset_id
        type: integer
        description: Asset ID for hierarchy-based grouping
      - name: quantity_id
        type: integer
        description: "Quantity ID (e.g., 185 for Active Power)"
      - name: quantity_search
        type: string
        description: "Quantity search: power, flow, pressure, voltage, etc."
      - name: period
        type: string
        description: "Time period: '7d', '30d', '1M' (default: 7d)"
      - name: start_date
        type: string
        description: Explicit start date (YYYY-MM-DD)
      - name: end_date
        type: string
        description: Explicit end date (YYYY-MM-DD)
      - name: bucket
        type: string
        description: "Bucket size: '1hour', '1day', '1week' (auto if omitted)"
        enum: [1hour, 1day, 1week]
      - name: top_n
        type: integer
        description: "Number of top peaks to return (default: 10)"
        default: 10
      - name: breakdown
        type: string
        description: "Breakdown: 'none' or 'device_daily' (default: none)"
        enum: [none, device_daily]
        default: none
