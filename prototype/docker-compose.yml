version: '3.8'

# Prototype: Open WebUI + Keycloak for testing __user__ context injection
# Task: pfn_mcp-6ar - Verify __user__ context in Open WebUI Python tools
# VPS: 88.222.213.96

services:
  postgres-keycloak:
    image: postgres:16-alpine
    container_name: proto-postgres-keycloak
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KC_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    networks:
      - proto-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 5s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: proto-keycloak
    environment:
      - KC_BOOTSTRAP_ADMIN_USERNAME=admin
      - KC_BOOTSTRAP_ADMIN_PASSWORD=${KC_ADMIN_PASSWORD:-admin}
      - KC_HTTP_ENABLED=true
      - KC_HOSTNAME_URL=http://88.222.213.96:8080
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_PROXY_HEADERS=xforwarded
      # Database
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://postgres-keycloak:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KC_DB_PASSWORD:-keycloak}
    ports:
      - "8080:8080"
    command: start-dev
    depends_on:
      postgres-keycloak:
        condition: service_healthy
    networks:
      - proto-net
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080"]
      interval: 10s
      timeout: 5s
      retries: 10

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: proto-openwebui
    environment:
      # OAuth Configuration
      - ENABLE_OAUTH_SIGNUP=true
      - OAUTH_PROVIDER_NAME=Keycloak
      - OPENID_PROVIDER_URL=http://88.222.213.96:8080/realms/pfn/.well-known/openid-configuration
      - OAUTH_CLIENT_ID=openwebui
      - OAUTH_CLIENT_SECRET=${OAUTH_CLIENT_SECRET}
      - OAUTH_SCOPES=openid email profile groups
      # Group sync from OAuth
      - ENABLE_OAUTH_GROUP_MANAGEMENT=true
      - OAUTH_GROUP_CLAIM=groups
      - ENABLE_OAUTH_GROUP_CREATION=true
      # WebUI settings
      - WEBUI_SECRET_KEY=${WEBUI_SECRET_KEY}
      - WEBUI_URL=http://88.222.213.96:3000
      # Disable default login form for OAuth-only
      - ENABLE_LOGIN_FORM=false
      # Allow running without Ollama (we just need tools to work)
      - OLLAMA_BASE_URL=
    ports:
      - "3000:8080"
    volumes:
      - open-webui-data:/app/backend/data
    depends_on:
      keycloak:
        condition: service_healthy
    networks:
      - proto-net

volumes:
  keycloak-db-data:
  open-webui-data:

networks:
  proto-net:
    driver: bridge
